<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador QR vCard desde CSV</title>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: grid;
            place-items: center;
            min-height: 90vh;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            text-align: center;
            padding: 2rem 3rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            margin-top: 0;
        }
        p {
            color: #555;
            max-width: 400px;
        }
        #drop-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 3rem;
            transition: all 0.3s ease;
        }
        #file-label {
            cursor: pointer;
            display: block;
            font-weight: bold;
            color: #007bff;
        }
        #file-label:hover {
            text-decoration: underline;
        }
        #drop-area.highlight {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        #file-info {
            margin-top: 1rem;
            font-weight: bold;
            color: #0056b3;
        }
        #process-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: background-color 0.3s ease;
        }
        #process-button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #process-button:not(:disabled):hover {
            background-color: #0056b3;
        }
        #status {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #d9534f;
        }
        #status.success {
            color: #5cb85c;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Generador de vCard QR</h1>
        <p>Arrastra tu archivo CSV de "purchases" a la zona punteada, o haz clic en el texto azul para seleccionarlo.</p>
        
        <div id="drop-area">
            <input type="file" id="file-input" accept=".csv" style="display: none;">
            <label for="file-input" id="file-label">Haz clic aquí para seleccionar tu archivo CSV</label>
            <span style="color: #888; display: block; margin-top: 0.5rem;">...o arrastra y suelta el archivo aquí</span>
            <div id="file-info"></div>
        </div>

        <button id="process-button" disabled>Sube un archivo primero</button>
        <div id="status"></div>
    </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileLabel = document.getElementById('file-label');
        const processButton = document.getElementById('process-button');
        const statusEl = document.getElementById('status');
        let csvFile = null;

        // --- Eventos de Drag & Drop ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files), false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            handleFiles(e.dataTransfer.files);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                csvFile = files[0];
                fileInfo.textContent = `Archivo seleccionado: ${csvFile.name}`;
                fileLabel.textContent = 'Archivo listo para procesar';
                processButton.disabled = false;
                processButton.textContent = 'Procesar y Generar QRs';
                statusEl.textContent = '';
            }
        }

        // --- Lógica Principal ---
        processButton.addEventListener('click', async () => {
            if (!csvFile) return;

            processButton.disabled = true;
            processButton.textContent = 'Procesando...';
            statusEl.classList.remove('success');
            statusEl.textContent = 'Leyendo y limpiando CSV...';

            try {
                // 1. Leer el CSV
                const results = await parseCSV(csvFile);
                statusEl.textContent = `CSV leído. ${results.data.length} filas encontradas.`;
                
                // 2. Limpiar datos y generar vCards
                const vCards = processData(results.data);
                statusEl.textContent = `Datos limpios. ${vCards.length} vCards válidas creadas.`;

                // 3. Generar QRs y Zippear
                if (vCards.length > 0) {
                    statusEl.textContent = 'Generando códigos QR...';
                    const zip = await generateZip(vCards);
                    
                    statusEl.textContent = 'Descargando ZIP...';
                    const content = await zip.generateAsync({ type: 'blob' });
                    
                    // 4. Descargar
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = 'QRs_vCard.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    statusEl.classList.add('success');
                    statusEl.textContent = `¡Listo! Se ha descargado "QRs_vCard.zip".`;
                } else {
                    statusEl.textContent = 'Error: No se encontraron datos válidos (Nombre, Email, WhatsApp) en el CSV. Revisa que las columnas tengan datos.';
                }

            } catch (error) {
                console.error(error);
                let errorMsg = error.message || error.toString() || "Un error desconocido ocurrió.";
                if (errorMsg.includes("Papa is not defined")) {
                    errorMsg = "La librería de CSV no cargó. Refresca la página e intenta de nuevo."
                }
                statusEl.textContent = `Error: ${errorMsg}`;
            } finally {
                processButton.disabled = false;
                processButton.textContent = 'Procesar de nuevo';
                fileLabel.textContent = 'Haz clic aquí para seleccionar otro archivo CSV';
                fileInfo.textContent = '';
                csvFile = null; // Resetear el archivo
            }
        });

        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                // Aquí usamos Papa, que ya debería estar definido
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "ISO-8859-1",
                    complete: resolve,
                    error: reject
                });
            });
        }

        function processData(rows) {
            return rows.map(row => {
                const nameRaw = row['Nombre y apellido'] || '';
                const emailRaw = row['Email'] || '';
                const phoneRaw = row['WhatsApp'] || '';
                const rutRaw = row['Identificacion fiscal'] || '';
                
                const name = nameRaw.trim().replace(/"/g, '');
                const email = emailRaw.trim();
                let phone = phoneRaw.trim().replace(/"/g, '').replace(/\s/g, '');
                if (phone && !phone.startsWith('+')) {
                    phone = `+${phone}`;
                }
                const rut = rutRaw.trim();
                
                if (name && (email || phone)) {
                    const nameParts = name.split(' ');
                    const lastName = nameParts.pop() || '';
                    const firstName = nameParts.join(' ') || '';

                    const vCardString = [
                        'BEGIN:VCARD',
                        'VERSION:3.0',
                        `N:${lastName};${firstName};;;`,
                        `FN:${name}`,
                        email ? `EMAIL:${email}` : '',
                        phone ? `TEL;TYPE=CELL:${phone}` : '',
                        rut ? `NOTE:RUT: ${rut}` : '',
                        'END:VCARD'
                    ].filter(Boolean).join('\n');

                    // Nombre de archivo seguro
                    const safeFileName = name.replace(/[^a-z0-9_-\s]/gi, '').replace(/ /g, '_');
                    
                    return {
                        // Usar RUT o email como desempate para el nombre de archivo
                        fileName: `${safeFileName || 'contacto'}_${(rut || email || 'qr').replace(/[^a-z0-9]/gi, '')}.png`,
                        vCard: vCardString
                    };
                }
                return null;
            }).filter(Boolean);
        }

        async function generateZip(vCards) {
            // Aquí usamos JSZip
            const zip = new JSZip();
            const qrCanvas = document.createElement('canvas');

            for (const item of vCards) {
                // Aquí usamos QRious
                const qr = new QRious({
                    element: qrCanvas,
                    value: item.vCard,
                    size: 400,
                    level: 'L'
                });
                
                const blob = await new Promise(resolve => qrCanvas.toBlob(resolve, 'image/png'));
                zip.file(item.fileName, blob);
            }
            return zip;
        }

    </script>
</body>
</html>
